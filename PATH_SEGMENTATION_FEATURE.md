# 路径智能分割功能

## 功能概述

针对您提出的问题，我们实现了**路径智能分割功能**，能够对部分遮挡的路径进行精细处理：

- ✅ **保留露出部分**：切割路径中露出的最顶层部分被保留
- ✅ **删除遮挡部分**：只删除完全被遮挡的路径段
- ✅ **智能分割**：将部分遮挡的路径分割为多个可见段
- ✅ **精确控制**：避免简单粗暴地删除整条路径

## 问题分析

### 原始问题
从您提供的图片可以看到：
- 红框区域明显存在多层路径
- 有些路径部分被遮挡，部分露出
- 简单的整条路径删除会丢失有用的露出部分

### 解决方案
实现**点级别的可见性分析**：
1. 检查每个路径点是否被遮挡
2. 识别连续的可见段
3. 将部分遮挡的路径分割为多个可见段
4. 只保留真正露出的部分

## 核心算法

### 1. 点级别可见性检测
```cpp
bool isPointOccluded(const PathPoint& point, int pathIndex, int candidateOccluderIndex) {
    // 检查单个点是否被其他路径遮挡
    // 基于投影重叠和深度比较
}
```

**检测原理**：
- 计算点在垂直于喷涂方向平面上的投影
- 检查是否在遮挡路径的投影范围内
- 考虑深度差异和容差

### 2. 可见段识别
```cpp
std::vector<std::pair<int, int>> findVisibleSegments(const std::vector<bool>& pointVisibility) {
    // 找到连续的可见点段
    // 返回每个可见段的起止索引
}
```

**识别逻辑**：
- 扫描点可见性数组
- 识别连续的可见点序列
- 生成段的起止索引对

### 3. 路径分割
```cpp
void segmentPartiallyOccludedPaths() {
    // 将部分遮挡的路径分割为多个可见段
    // 每个段都是完全可见的
}
```

**分割策略**：
- 遍历所有路径的可见段
- 为每个可见段创建新的独立路径
- 过滤掉太短的段（少于2个点）
- 重新分配路径索引

## 处理流程

### 完整流程
```
原始路径生成
    ↓
深度计算
    ↓
粗略遮挡检测
    ↓
点级别可见性分析 ⭐
    ↓
可见段识别 ⭐
    ↓
路径智能分割 ⭐
    ↓
表面层级分类
    ↓
可见性过滤
    ↓
轨迹整合
```

### 分割示例
```
原始路径: [P1][P2][P3][P4][P5][P6][P7][P8]
可见性:   [ T][ T][ F][ F][ T][ T][ T][ F]
         
分割结果:
段1: [P1][P2]        (可见段 0-1)
段2: [P5][P6][P7]    (可见段 4-6)
```

## 关键参数

### 可见性阈值
- **最小可见比例**: 10% (路径至少10%的点可见才保留)
- **最小段长度**: 2个点 (太短的段会被过滤)
- **投影容差**: `pathSpacing * 0.3` (避免边界效应)

### 深度阈值
- **遮挡深度差**: `pathSpacing * 0.5` (深度差异阈值)
- **层级分离**: `pathSpacing * 0.8` (层级分类阈值)

## 实际效果

### 处理前
- 看到完整的原始路径
- 包含被遮挡的部分
- 视觉上存在重叠和混乱

### 处理后
- 只显示露出的路径段
- 被遮挡部分被精确移除
- 保留了所有有用的可见部分
- 界面更清晰，喷涂更精确

## 技术优势

### 1. 精确性
- 点级别的精确分析
- 避免过度删除有用路径
- 保留所有真正需要喷涂的部分

### 2. 智能性
- 自动识别部分遮挡情况
- 智能分割复杂的遮挡模式
- 适应各种几何形状

### 3. 效率性
- 减少无效喷涂
- 提高涂料利用率
- 优化喷涂路径

### 4. 灵活性
- 可调节的阈值参数
- 适应不同的应用场景
- 支持复杂的多层结构

## 控制台输出示例

```
开始表面可见性分析...
计算了 45 条路径的深度
检测到 12 条被遮挡的路径
开始点级别可见性分析...
点级别可见性分析完成
开始分割部分遮挡的路径...
路径分割完成，生成了 38 个路径段
分类为 3 个表面层级
过滤结果: 28/38 条路径段可见，其中 15 条为分割后的可见段
最表层包含 18 条可见路径段
已对部分遮挡的路径进行智能分割，只保留露出的部分
```

## 可视化效果

### 颜色编码
- **绿色**: 喷涂路径段（露出的可见部分）
- **橙色**: 连接路径（非喷涂的过渡段）
- **隐藏**: 被遮挡的路径部分（完全不显示）

### 显示特点
- 只显示真正需要喷涂的部分
- 自动过滤被遮挡的无用段
- 保持路径的连续性和完整性

## 应用场景

### 适用情况
1. **复杂几何体**: 多层结构的工件
2. **深槽加工**: 有内部遮挡的形状
3. **精密喷涂**: 要求高精度的应用
4. **成本敏感**: 需要最大化涂料利用率

### 效果对比
- **传统方法**: 简单删除整条被遮挡路径
- **智能分割**: 保留露出部分，删除遮挡部分
- **结果**: 更精确的喷涂覆盖，更高的效率

## 总结

路径智能分割功能完美解决了您提出的问题：

1. **精确识别**: 准确识别哪些部分被遮挡
2. **智能保留**: 保留切割路径中露出的最顶层部分
3. **精确删除**: 只删除真正被遮挡的部分
4. **优化效果**: 显著提高喷涂精度和效率

这个功能让系统能够处理复杂的多层遮挡情况，确保每一滴涂料都用在真正需要的地方！
